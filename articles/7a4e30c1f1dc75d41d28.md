---
title: "[Unity] åŠ¹æœéŸ³å†ç”Ÿã‚’ä¸€å…ƒç®¡ç†ã™ã‚‹SoundPlayer"
emoji: "ğŸµ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["unity", "messagepipe"]
published: true
---

æ¬¡ã®é–‹ç™ºã«æµç”¨ã§ããã†ãªã‚‚ã®ãŒå‡ºæ¥ãŸã¨æ€ã£ãŸã®ã§è¦šãˆæ›¸ãã€‚

## å®Ÿç¾ã—ãŸã‹ã£ãŸã“ã¨

- åŠ¹æœéŸ³ï¼ˆSEï¼‰ã®å†ç”Ÿã«é–¢ã™ã‚‹æ©Ÿèƒ½ï¼ˆéŸ³é‡èª¿æ•´ãªã©ï¼‰ã‚’ä¸€å…ƒç®¡ç†ã™ã‚‹ã“ã¨ã€‚
  - `AudioSource`ã®`Play()`ã€`PlayOneShot()` ç­‰ã®å†ç”Ÿå‡¦ç†ã‚’è¤‡æ•°å€‹æ‰€ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€éŸ³é‡èª¿æ•´ãªã©ãŒå¤§å¤‰ã«ãªã‚‹ã€‚
- ã‚·ãƒ¼ãƒ³åˆ‡ã‚Šæ›¿ãˆæ™‚ã«åŠ¹æœéŸ³ãŒé€”åˆ‡ã‚Œãªã„ã“ã¨ã€‚

## ç’°å¢ƒ

- Unity 6000.1.14f1
- MessagePipe
  - åŠ¹æœéŸ³ã®å†ç”Ÿãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é€å—ä¿¡ã«ä½¿ç”¨ã—ã¾ã—ãŸã€‚
- VContainer
  - MessagePipe ãŒä½¿ç”¨ã§ãã‚‹ DI ã‚³ãƒ³ãƒ†ãƒŠãªã‚‰ä½•ã§ã‚‚ã„ã„ã¨æ€ã„ã¾ã™ã€‚

## å‡¦ç†ã‚¤ãƒ¡ãƒ¼ã‚¸

```mermaid
sequenceDiagram
    box UI
        participant Button as ãƒœã‚¿ãƒ³ãªã©
    end
    box Presentation
        participant SoundPlayer
    end
    Note over SoundPlayer: DontDestroyOnLoad ã§å¸¸é§åŒ–
    Note over SoundPlayer: PlaySoundRequest ã‚’è³¼èª­ï¼ˆSubscribeï¼‰
    box Infrastructure
        participant AddressablesSoundLoader
    end
    Note over AddressablesSoundLoader: Applicationå±¤ã®ISoundLoaderã®å®Ÿè£…
    box Resources
        participant Addressables
    end

    Button->>SoundPlayer: PlaySoundRequest ã‚’é€ä¿¡ï¼ˆPublishï¼‰
    Note right of Button: ex) SoundId.Click_OK

    SoundPlayer->>AddressablesSoundLoader: LoadAssetAsync<AudioClip>(soundId)
    Note right of SoundPlayer: ISoundLoaderã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹çµŒç”±
    Note over AddressablesSoundLoader: å†…éƒ¨å¤‰æ›ï¼ˆSoundIdâ†’Addressï¼‰
    AddressablesSoundLoader->>Addressables: LoadAssetAsync<AudioClip>(address)

    Addressables-->>AddressablesSoundLoader: AudioClip ã‚’è¿”å´
    AddressablesSoundLoader-->>SoundPlayer: AudioClip ã‚’è¿”å´

    SoundPlayer->>SoundPlayer: å–å¾—ã—ãŸAudioClipã‚’å†ç”Ÿ
```

## å…·ä½“çš„ãªå®Ÿè£…

å®Ÿè£…ã™ã‚‹ã‚¯ãƒ©ã‚¹ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

- `PlaySoundRequest`ã‚¯ãƒ©ã‚¹
  - MessagePipe ã§é€å—ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¯ãƒ©ã‚¹ã§ã™ã€‚
    - ä»Šå›ã¯ã€Œ `PresentationEvent` ã€ã¨ã„ã†ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ã•ã›ã¾ã—ãŸã€‚ãŠå¥½ã¿ã§ã€‚
  - å†ç”Ÿã—ãŸã„åŠ¹æœéŸ³ã®ä¸€æ„ Idï¼ˆã“ã“ã§ã¯ `SoundId` ã¨å®šç¾©ï¼‰ã‚’ä¿æŒã—ã¾ã™ã€‚
  - ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã ã¨å¬‰ã—ã„ã€‚
    - ä»Šå›ã¯ `record` ã§å®šç¾©ã—ã¾ã—ãŸãŒã€`readonly struct` ãªã©ã§ã‚‚ä»£æ›¿å¯èƒ½ã®ã¯ãšã§ã™ã€‚ãŠå¥½ã¿ã§ã€‚
- `ISoundLoader` ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã€åŠã³ãã®å®Ÿè£…ã§ã‚ã‚‹ `AddressablesSoundLoader` ã‚¯ãƒ©ã‚¹
  - æŒ‡å®šã•ã‚ŒãŸåŠ¹æœéŸ³ï¼ˆAudioClipï¼‰ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚
  - å†ç”Ÿã¯ã—ã¾ã›ã‚“ã€‚
- `SoundPlayer`ã‚¯ãƒ©ã‚¹
  - MonoBehaviour ã‚’ç¶™æ‰¿ã—ã¾ã™ã€‚
  - DontDestroyOnLoad ä¸‹ã«å¸¸é§ã•ã›ã¾ã™ã€‚
    - ã‚·ãƒ¼ãƒ³æ¨ªæ–­æ™‚ã«å†ç”Ÿã—ãŸéŸ³ãŒé€”åˆ‡ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã§ã™ã€‚
  - `PlaySoundRequest`ã‚’è³¼èª­ï¼ˆSubscribeï¼‰ã—ã¾ã™ã€‚
    - æŒ‡å®šã•ã‚ŒãŸ `SoundId` ã‚’å…ƒã« `ISoundLoader` ã‹ã‚‰ AudioClip ã‚’èª­ã¿è¾¼ã¿ã€å†ç”Ÿã—ã¾ã™ã€‚
- ãƒœã‚¿ãƒ³ãªã©
  - åŠ¹æœéŸ³ã‚’å†ç”Ÿã—ãŸã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€`PlaySoundRequest`ã‚’é€ä¿¡ï¼ˆPublishï¼‰ã—ã¾ã™ã€‚

### PlaySoundRequest ã‚¯ãƒ©ã‚¹

å†ç”Ÿã™ã‚‹åŠ¹æœéŸ³ã‚’æŒ‡å®šã—ã¦é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™ã€‚

```csharp
namespace MyGame.Presentation.Events
{
    public record PlaySoundRequest : PresentationEvent
    {
        public SoundId SoundId { get; init; }
    }
}
```

`PresentationEvent`ã¯ãƒãƒ¼ã‚«ãƒ¼ç”¨ã®åŸºåº•ã‚¯ãƒ©ã‚¹ã§ã‚ã‚Šã€ç‰¹ã«æ©Ÿèƒ½ã¯æŒãŸã›ã¦ã„ã¾ã›ã‚“ã€‚

```csharp
namespace MyGame.Presentation.Events
{
    public abstract record PresentationEvent
    {
        // ç‰¹ã«ãªã—
        // å¿…è¦ã§ã‚ã‚Œã°ã€Œé€ä¿¡å…ƒã€ã€Œé€ä¿¡æ—¥æ™‚ã€ãªã©ã®å…±é€šãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å®Ÿè£…ã—ã¦ã‚‚ã‚ˆã•ãã†ã€‚
    }
}
```

`SoundId`ã¯åŠ¹æœéŸ³ã®åˆ—æŒ™å‹ã§ã™ã€‚
ã“ã“ã§ã¯ Addressables ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ç­‰ã¯å®šç¾©ã—ã¦ã„ã¾ã›ã‚“ã€‚
ï¼ˆAddressables ã—ã‹ä½¿ã‚ãªã„ã¨æ±ºã‚ã¦ã‚·ãƒ³ãƒ—ãƒ«ãªä½œã‚Šã«ã™ã‚‹ãªã‚‰ã€ã“ã“ã§å®šç¾©ã—ã¦ã‚‚ã„ã„ã¨æ€ã„ã¾ã™ã€‚ï¼‰

```csharp
namespace MyGame.Application
{
    public enum SoundId
    {
        Click_OK,
        Click_Cancel,
        ...
    }
}
```

### ISoundLoader ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã€AddressablesSoundLoader ã‚¯ãƒ©ã‚¹

Addressables ã‹ã‚‰åŠ¹æœéŸ³ã® AudioClip ã‚’èª­ã¿è¾¼ã‚“ã§è¿”å´ã—ã¾ã™ã€‚
ã“ã“ã§ã¯å†ç”Ÿã¯ã—ã¾ã›ã‚“ã€‚

```csharp
namespace MyGame.Application
{
    public interface ISoundLoader : IDisposable
    {
        UniTask<AudioClip> LoadAudioClipAsync(SoundId soundId, CancellationToken cancellationToken = default);
    }
}
```

```csharp
namespace MyGame.Infra
{
    public class AddressablesSoundLoader : ISoundLoader
    {
        private static readonly Dictionary<SoundId, string> _address = new()
        {
            // SoundIdåˆ—æŒ™å‹ã¨Addressablesã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¾ã™ã€‚
            [SoundId.Click_OK] = "Sounds/Click_OK",
            [SoundId.Click_Cancel] = "Sounds/Click_Cancel",
            ...
        };

        private readonly Dictionary<SoundId, AudioClip> _cache = new();

        public async UniTask<AudioClip> LoadAudioClipAsync(SoundId soundId, CancellationToken cancellationToken = default)
        {
            if(_cache.TryGetValue(soundId, out var cached))
                return cached;

            // SoundIdã‚’Addressã«å¤‰æ›
            var address = _address[soundId];

            // Addressablesã‹ã‚‰AudioClipã‚’å–å¾—
            var audioClip = await Addressables.LoadAssetAsync<AudioClip>(address)
                .ToUniTask(cancellationToken: cancellationToken);

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥
            _cache[soundId] = audioClip;

            return audioClip;
        }

        public void Dispose()
        {
            foreach (var clip in _cache.Values)
            {
                if (clip != null) Addressables.Release(clip);
            }
            _cache.Clear();
        }
    }
}
```

### SoundPlayer ã‚¯ãƒ©ã‚¹

å®Ÿéš›ã« AudioClip ã‚’å†ç”Ÿã™ã‚‹ã‚¯ãƒ©ã‚¹ã§ã™ã€‚

```csharp
namespace MyGame.Presentation
{
    public class SoundPlayer : ... // MonoBehaviourã‚’ç¶™æ‰¿
    {
        // ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­
        [Inject] private ISubscriber<PlaySoundRequest> _playSoundRequest = default!;

        [Inject] private ISoundLoader _soundLoader = default!;

        // å†ç”Ÿã—ãŸåŠ¹æœéŸ³ï¼ˆAudioSourceï¼‰ã‚’ç®¡ç†ã™ã‚‹ãƒ—ãƒ¼ãƒ«
        private ObjectPool<AudioSource> _audioSourcePool = default!;

        private void Awake()
        {
            // ...æ¤œè¨¼ãªã©ï¼ˆå‰²æ„›ï¼‰...

            // ãƒ—ãƒ¼ãƒ«ã‚’åˆæœŸåŒ–
            _audioSourcePool = new ObjectPool<AudioSource>(
                createFunc: () =>
                {
                    var go = new GameObject("Pooled Audio Source");
                    var item = go.AddComponent<AudioSource>();

                    // åˆæœŸè¨­å®š
                    item.playOnAwake = false;

                    // è‡ªèº«ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã«åˆã‚ã›ã‚‹
                    go.transform.SetParent(transform);

                    return item;
                },
                actionOnGet: item =>
                {
                    item.gameObject.SetActive(true);
                },
                actionOnRelease: item =>
                {
                    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                    item.Stop();
                    item.clip = null;
                    item.gameObject.SetActive(false);
                },
                actionOnDestroy: item =>
                {
                    if (item != null && item.gameObject != null)
                    {
                        try
                        {
                            Destroy(item.gameObject);
                        }
                        catch (MissingReferenceException)
                        {
                            // ç ´æ£„æ¸ˆã¿ã®å ´åˆã¯ç„¡è¦–
                        }
                    }
                },
                collectionCheck: true,
                defaultCapacity: 10,
                maxSize: 30
            );

            // ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­
            _playSoundRequest?.Subscribe(e =>
            {
                // å†ç”Ÿ
                _OnSoundPlayRequested(e).Forget();
            }).AddTo(this);
        }

        private void OnDestroy()
        {
            _audioSourcePool?.Clear();
            _audioSourcePool?.Dispose();
        }

        private async UniTask _OnSoundPlayRequested(PlaySoundRequest e)
        {
            var audioSource = _audioSourcePool.Get();
            try
            {
                // AudioClipã‚’èª­ã¿è¾¼ã¿
                audioSource.clip = await _soundLoader.LoadAudioClipAsync(e.SoundId, _cancellationTokenSource.Token);

                // å¿…è¦ã§ã‚ã‚Œã°ã“ã“ã§éŸ³é‡èª¿æ•´ãªã©

                // å†ç”Ÿ
                await audioSource.PlayAsync(_cancellationTokenSource.Token);
            }
            finally
            {
                // è¿”å´
                if (audioSource != null && _audioSourcePool != null)
                {
                    _audioSourcePool.Release(audioSource);
                }
            }
        }
    }
}
```

ã“ã® `SoundPlayer` ã‚¯ãƒ©ã‚¹ï¼ˆMonoBehaviour ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰ã‚’ DontDestroyOnLoad ä¸‹ã«å¸¸é§ã•ã›ã¾ã™ã€‚

```csharp
// VContainerã§ã®ä¾‹
builder.RegisterComponentOnNewGameObject<SoundPlayer>(Lifetime.Singleton)
    .DontDestroyOnLoad();
```

### ãƒœã‚¿ãƒ³ãªã©

åŠ¹æœéŸ³ã‚’å†ç”Ÿã—ãŸã„æ™‚ã« `PlaySoundRequest` ã‚’é€ä¿¡ã—ã¾ã™ã€‚

```csharp
namespace MyGame.Presentation
{
    public class SampleButton : ...
    {
        [SerializeField] private Button _button;
        ...
        [Inject] private IPublisher<PlaySoundRequest> _playSoundRequest = default!;

        private void Awake()
        {
            ...

            // UIã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
            // ï¼ˆR3ã‚’ä½¿ç”¨ã—ãŸä¾‹ã§ã™ã€‚æ¨™æº–ã®OnClickã§ã‚‚å¯ï¼‰
            _button.OnClickAsObservable().Subscribe(async _ =>
            {
                ...
                // ã‚µã‚¦ãƒ³ãƒ‰å†ç”Ÿ
                _playSoundRequest?.Publish(new PlaySoundRequest
                {
                    SoundId = SoundId.Click_OK
                });
                ...
            }).AddTo(this);
        }
        ...
    }
}
```

ã“ã†ã™ã‚‹ã“ã¨ã§ã€

1. ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã‚‹
2. PlaySoundRequest ãŒé€ä¿¡ã•ã‚Œã‚‹
3. SoundPlayer ãŒãã‚Œã‚’å—ä¿¡ã—ã€å¯¾å¿œã™ã‚‹ AudioClip ã‚’å†ç”Ÿã™ã‚‹

ã¨ã„ã†æµã‚Œã«ãªã‚Šã¾ã—ãŸã€‚

## ç–‘å•ãƒ»æœªæ¤œè¨¼

åŒæ™‚ã« 10,000 å€‹ã®åŠ¹æœéŸ³å†ç”ŸãŒé‡è¤‡ã—ã¦ã‚‚ã¡ã‚ƒã‚“ã¨å†ç”Ÿã•ã‚Œã‚‹ã ã‚ã†ã‹ï¼Ÿï¼ˆãã‚ŒãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹ã‚’æƒ³å®šã—ã¦ã„ãªã„ã®ã§æ¤œè¨¼ã—ã¦ã„ã¾ã›ã‚“ï¼‰

## æ‰€æ„Ÿãªã©

æ”¹å–„ç‚¹ãªã©ã‚ã‚Œã°ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—ã—ã¦ã„ããŸã„ã§ã™ã€‚
ã‚ã¨ã€BGM ã‚‚ä¼¼ãŸã‚ˆã†ãªä»•çµ„ã¿ã‚’æ§‹ç¯‰ã—ã¦ãŠãã¨æ¥½ãã†ã ãªã¨æ€ã„ã¾ã—ãŸã€‚

## ä½™è«‡

`ISoundLoader` ã‚’çµŒç”±ã™ã‚‹ï¼ˆAddressables ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¤–éƒ¨åŒ–ã™ã‚‹ï¼‰ã®ãŒå†—é•·ã ã¨æ„Ÿã˜ã‚‹å ´åˆã¯ã€`SoundPlayer`å†…ã§ Addressables ã® AudioClip èª­ã¿è¾¼ã¿ â†’ å†ç”Ÿã€ã¨ã—ã¦ã‚‚ã„ã„ã¨æ€ã„ã¾ã™ã€‚ãŠå¥½ã¿ã§ã€‚

```mermaid
sequenceDiagram
    box UI
        participant Button as ãƒœã‚¿ãƒ³ãªã©
    end
    box Presentation
        participant SoundPlayer
    end
    Note over SoundPlayer: DontDestroyOnLoad ã§å¸¸é§åŒ–
    Note over SoundPlayer: PlaySoundRequest ã‚’è³¼èª­ï¼ˆSubscribeï¼‰
    box Resources
        participant Addressables
    end

    Button ->> SoundPlayer: PlaySoundRequest ã‚’é€ä¿¡ï¼ˆPublishï¼‰
    Note right of Button: ex) SoundId.Click_OK

    Note over SoundPlayer: å†…éƒ¨å¤‰æ›ï¼ˆSoundIdâ†’Addressï¼‰
    SoundPlayer ->> Addressables: LoadAssetAsync<AudioClip>(soundId)
    Addressables -->> SoundPlayer: AudioClip ã‚’è¿”å´

    SoundPlayer ->> SoundPlayer: å–å¾—ã—ãŸAudioClipã‚’å†ç”Ÿ
```
