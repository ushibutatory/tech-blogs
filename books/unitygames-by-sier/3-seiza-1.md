---
title: "「星座づくり」(1) 概要"
---

## なにこれ

ランダムに配置される星をつないで、星座を描くゲームです。
描いた星座の形をもとに、AI に星座名と物語を考えてもらいます。

AI はコスト重視で「GroqAPI」を採用しました。

- 動作確認
  - unityroom
    - <https://unityroom.com/games/seiza-zukuri>
  - GitHub
    - <https://github.com/ushibutatory/game-stella_generator-pages>

## 使用ライブラリ、環境など

※アーキテクチャに関するもののみ記載

### Unity

- UniTask
  - 非同期処理のため
- MessagePipe
  - Pub/Sub パターン実装のため
  - 主に以下の用途で使用しています。
    - レイヤー間の通信、特に「メソッドの戻り値（＝実行結果）」に該当する処理。
    - プレゼンテーション層における、オブジェクト間の通信。
- VContainer
  - DI コンテナ
- R3
  - Rx ライブラリ

### API

- AWS Lambda + API Gateway
  - Groq API キー及びプロンプトを秘匿するため
- Node.js
- Groq SDK
  - GroqAPI を実行するため

## アーキテクチャ

ローカルルール（特に命名）統一のため、用語を自分の言葉で再定義したりしていました。

### ドメイン層

- 責務
  - 状態の整合性を担保すること。
    - 「ドメインのルール」を常に守っていることを保証する。
    - 外部からの操作によって整合性を失わせることはできない。
- 提供機能
  - **Entity**
    - 「定義」と「状態」を持つモデル。
    - 「定義」はエンティティ生成時のパラメータとなり、生成後は変更されない。
    - 「状態」はエンティティ生成時に初期化され、適宜変更される可能性がある。
      - 「状態」は常に整合性が保たれている。
  - **ValueObject**
    - イミュータブルな構造体のうち、特にドメインの表現に特化したもの。
  - **Repository**（インタフェース）
    - ユースケースが「状態を持たないワークフロー」であるのに対し、リポジトリは「状態の参照や操作」を提供する。
      - Repository 自体が内部状態を持つこともあれば、ドメインを参照することもあるし、インフラ層を経由して外部と通信することもある。Repository インタフェースはそれらの実装を隠蔽する。
  - **Repository**（実装クラス）
    - Repository の中でもメモリだけで管理するもの。
    - 今回のゲームで言えば「ランダム生成された星 Entity リポジトリ」。
      - 外部ストレージやサービスを使用せず、アプリケーション層で生成された星を保管しておくクラス。
  - **DomainEvent**
    - 状態が更新された際に通知する。
    - 次項で詳細記述

### アプリケーション層

- 責務
  - プレゼンテーション層からの要求にあわせて、ドメイン層に更新を要求する。
  - ドメイン操作を組み合わせてユースケースを表現する。
  - アプリケーションを構成する様々な状態の参照を提供する。
- 提供機能
  - **UseCase**
    - 取得用ユースケース
      - 戻り値でデータ（DTO）を返す。
      - エンティティから DTO への変換は各ユースケースで行う。
    - 更新用ユースケース
      - 原則、戻り値で具体的なデータは返さない。
      - メッセージで結果を通知する。必要に応じてデータを同梱する。
  - **ApplicationEvent**
    - ユースケース実行が完了または失敗した際に通知する。
    - 次項で詳細記述

### プレゼンテーション層

- 責務
  - UI イベントをハンドリングし、アプリケーション層に処理を要求する（ユースケースを実行する）。
- 提供機能
  - **View** など
    - UI 部品にあわせて MonoBehaviour を継承したコンポーネントを作成する。
    - オブジェクトと同期しながら、UI イベントのハンドリングやアプリケーション層への要求を行う。
  - **PresentationEvent**
    - 他 コンポーネント に処理を通知する（ボタンがクリックされた、等）。
    - 次項で詳細記述

### コア層（図には描いていない）

- 責務
  - Logging 機能や、汎用的な構造体や列挙型、拡張メソッドなどを定義する。

### インフラ層

- 責務
  - データの永続化
  - 外部サービスとの接続、通信
- 提供機能
  - `Addressables` からのアセットの取得
  - GroqAPI へのアクセス
